---
layout: post
title: Custom Restito Sequenced Stub Action
date: '2016-05-06T22:51:00.000+02:00'
author: Libor Kramoli≈°
tags:
- testing
- restito
- rest
- mock
- java
modified_time: '2016-05-06T23:04:08.173+02:00'
blogger_id: tag:blogger.com,1999:blog-2759548145050416517.post-2458438654658521532
blogger_orig_url: http://yatel.kramolis.cz/2016/05/restito-sequenced-stub-action.html
---

In this post I show how to write custom <a href="https://github.com/mkotsur/restito">Restito</a> <a href="https://mkotsur.github.io/restito/javadoc/current/com/xebialabs/restito/semantics/Action.html">Action</a> to mock a single REST endpoint to response differently even is subsequent requests are identical.<br /><br /><b>Restito</b> is lightweight testing framework that provides a Java DSL to:<br /><ul><li>mimic REST server behavior,</li><li>perform verification against happened calls.</li></ul><div>It is based on <a href="https://grizzly.java.net/">Grizzly HTTP Server</a>. See <a href="https://github.com/mkotsur/restito/blob/master/guide.md">developer's guide</a> for more details about all supported features.</div><div><br /></div><div>Let's say I want to test business login of application that calls following REST API:</div><div><ol><li>Gets list of all open comments (<span style="font-family: &quot;verdana&quot; , sans-serif; font-size: x-small;">GET /comments</span>),</li><li>Archives each comment that is older than a month (<span style="font-family: &quot;verdana&quot; , sans-serif; font-size: x-small;">DELETE /comments/{id}</span>),</li><li>Lists all remaining open comments (<span style="font-family: &quot;verdana&quot; , sans-serif; font-size: x-small;">GET /comments</span>).</li></ol><!-- HTML generated using hilite.me --><br /><div style="background: #272822; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">java.util.List</span><span style="color: #f92672;">;</span><br /><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">com.xebialabs.restito.builder.ensure.EnsureHttp</span><span style="color: #f92672;">;</span><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">com.xebialabs.restito.support.junit.StartServer</span><span style="color: #f92672;">;</span><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.junit.Before</span><span style="color: #f92672;">;</span><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.junit.Rule</span><span style="color: #f92672;">;</span><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.junit.Test</span><span style="color: #f92672;">;</span><br /><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">static</span> <span style="color: #f8f8f2;">com</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">xebialabs</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">restito</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">builder</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">stub</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">StubHttp</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">whenHttp</span><span style="color: #f92672;">;</span><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">static</span> <span style="color: #f8f8f2;">com</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">xebialabs</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">restito</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">semantics</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">Action</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">contentType</span><span style="color: #f92672;">;</span><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">static</span> <span style="color: #f8f8f2;">com</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">xebialabs</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">restito</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">semantics</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">Action</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">status</span><span style="color: #f92672;">;</span><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">static</span> <span style="color: #f8f8f2;">com</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">xebialabs</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">restito</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">semantics</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">Action</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">stringContent</span><span style="color: #f92672;">;</span><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">static</span> <span style="color: #f8f8f2;">com</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">xebialabs</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">restito</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">semantics</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">Condition</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">delete</span><span style="color: #f92672;">;</span><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">static</span> <span style="color: #f8f8f2;">com</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">xebialabs</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">restito</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">semantics</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">Condition</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">get</span><span style="color: #f92672;">;</span><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">static</span> <span style="color: #f8f8f2;">org</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">glassfish</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">grizzly</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">http</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">util</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">HttpStatus</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">NO_CONTENT_204</span><span style="color: #f92672;">;</span><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">static</span> <span style="color: #f8f8f2;">org</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">glassfish</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">grizzly</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">http</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">util</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">HttpStatus</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">OK_200</span><span style="color: #f92672;">;</span><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">static</span> <span style="color: #f8f8f2;">org</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">hamcrest</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">Matchers</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">hasSize</span><span style="color: #f92672;">;</span><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">static</span> <span style="color: #f8f8f2;">org</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">junit</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">Assert</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">assertThat</span><span style="color: #f92672;">;</span><br /><br /><span style="color: #66d9ef;">public</span> <span style="color: #66d9ef;">class</span> <span style="color: #a6e22e;">MyAppTest</span> <span style="color: #f92672;">{</span><br /><br />    <span style="color: #66d9ef;">private</span> <span style="color: #66d9ef;">static</span> <span style="color: #66d9ef;">final</span> <span style="color: #f8f8f2;">String</span> <span style="color: #f8f8f2;">GET_COMMENTS_BEFORE</span> <span style="color: #f92672;">=</span><br />              <span style="color: #e6db74;">"{\"comments\":[\n"</span><br />            <span style="color: #f92672;">+</span> <span style="color: #e6db74;">"    {\"id\" : 1, \"content\" : \"Happy New Year ...\", \"date\" : \"2016-01-01\"},\n"</span><br />            <span style="color: #f92672;">+</span> <span style="color: #e6db74;">"    {\"id\" : 2, \"content\" : \"Happy Valentine...\", \"date\" : \"2016-02-14\"},\n"</span><br />            <span style="color: #f92672;">+</span> <span style="color: #e6db74;">"    {\"id\" : 3, \"content\" : \"I like Restito ...\", \"date\" : \"2016-05-06\"}\n"</span><br />            <span style="color: #f92672;">+</span> <span style="color: #e6db74;">"]}"</span><span style="color: #f92672;">;</span><br />    <span style="color: #66d9ef;">private</span> <span style="color: #66d9ef;">static</span> <span style="color: #66d9ef;">final</span> <span style="color: #f8f8f2;">String</span> <span style="color: #f8f8f2;">GET_COMMENTS_AFTER</span> <span style="color: #f92672;">=</span><br />              <span style="color: #e6db74;">"{\"comments\":[\n"</span><br />            <span style="color: #f92672;">+</span> <span style="color: #e6db74;">"    {\"id\" : 3, \"content\" : \"I like Restito ...\", \"date\" : \"2016-05-06\"}\n"</span><br />            <span style="color: #f92672;">+</span> <span style="color: #e6db74;">"]}"</span><span style="color: #f92672;">;</span><br /><br />    <span style="color: #a6e22e;">@Rule</span><br />    <span style="color: #66d9ef;">public</span> <span style="color: #f8f8f2;">StartServer</span> <span style="color: #f8f8f2;">startServer</span> <span style="color: #f92672;">=</span> <span style="color: #66d9ef;">new</span> <span style="color: #f8f8f2;">StartServer</span><span style="color: #f92672;">();</span><br /><br />    <span style="color: #a6e22e;">@Test</span><br />    <span style="color: #66d9ef;">public</span> <span style="color: #66d9ef;">void</span> <span style="color: #a6e22e;">testArchiveOldComments</span><span style="color: #f92672;">()</span> <span style="color: #f92672;">{</span><br />        <span style="color: #75715e;">// 1. Stub for: Gets list of all open comments (GET /comments):</span><br />        <span style="color: #f8f8f2;">whenHttp</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">startServer</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">getServer</span><span style="color: #f92672;">()).</span><br />                <span style="color: #f8f8f2;">match</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">get</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"/comments"</span><span style="color: #f92672;">)).</span><br />                <span style="color: #f8f8f2;">then</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">status</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">OK_200</span><span style="color: #f92672;">),</span><br />                     <span style="color: #f8f8f2;">contentType</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"application/json"</span><span style="color: #f92672;">),</span><br />                     <span style="color: #f8f8f2;">stringContent</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">GET_COMMENTS_BEFORE</span><span style="color: #f92672;">)).</span><br />                <span style="color: #f8f8f2;">mustHappen</span><span style="color: #f92672;">();</span><br />        <span style="color: #75715e;">// 2. Stub for: Archives each comment that is older than a month (DELETE /comments/{id}):</span><br />        <span style="color: #f8f8f2;">whenHttp</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">startServer</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">getServer</span><span style="color: #f92672;">()).</span><br />                <span style="color: #f8f8f2;">match</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">delete</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"/comments/1"</span><span style="color: #f92672;">)).</span><br />                <span style="color: #f8f8f2;">then</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">status</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">NO_CONTENT_204</span><span style="color: #f92672;">)).</span><br />                <span style="color: #f8f8f2;">mustHappen</span><span style="color: #f92672;">();</span><br />        <span style="color: #f8f8f2;">whenHttp</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">startServer</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">getServer</span><span style="color: #f92672;">()).</span><br />                <span style="color: #f8f8f2;">match</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">delete</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"/comments/2"</span><span style="color: #f92672;">)).</span><br />                <span style="color: #f8f8f2;">then</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">status</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">NO_CONTENT_204</span><span style="color: #f92672;">)).</span><br />                <span style="color: #f8f8f2;">mustHappen</span><span style="color: #f92672;">();</span><br />        <span style="color: #75715e;">// 3. Stub for: Lists all remaining open comments (GET /comments):</span><br />        <span style="color: #f8f8f2;">whenHttp</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">startServer</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">getServer</span><span style="color: #f92672;">()).</span><br />                <span style="color: #f8f8f2;">match</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">get</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"/comments"</span><span style="color: #f92672;">)).</span><br />                <span style="color: #f8f8f2;">then</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">status</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">OK_200</span><span style="color: #f92672;">),</span><br />                     <span style="color: #f8f8f2;">contentType</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"application/json"</span><span style="color: #f92672;">),</span><br />                     <span style="color: #f8f8f2;">stringContent</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">GET_COMMENTS_AFTER</span><span style="color: #f92672;">)).</span><br />                <span style="color: #f8f8f2;">mustHappen</span><span style="color: #f92672;">();</span><br /><br />        <span style="color: #75715e;">// call business logic</span><br />        <span style="color: #f8f8f2;">MyApp</span> <span style="color: #f8f8f2;">myApp</span> <span style="color: #f92672;">=</span> <span style="color: #66d9ef;">new</span> <span style="color: #f8f8f2;">MyApp</span><span style="color: #f92672;">();</span><br />        <span style="color: #f8f8f2;">List</span><span style="color: #f92672;">&lt;</span><span style="color: #f8f8f2;">Comment</span><span style="color: #f92672;">&gt;</span> <span style="color: #f8f8f2;">comments</span> <span style="color: #f92672;">=</span> <span style="color: #f8f8f2;">myApp</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">archiveOldComments</span><span style="color: #f92672;">();</span><br /><br />        <span style="color: #75715e;">// remaining 1 comment:</span><br />        <span style="color: #f8f8f2;">assertThat</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">comments</span><span style="color: #f92672;">,</span> <span style="color: #f8f8f2;">hasSize</span><span style="color: #f92672;">(</span><span style="color: #ae81ff;">1</span><span style="color: #f92672;">));</span><br />        <span style="color: #75715e;">// ensure that each stubs has been invoked:</span><br />        <span style="color: #f8f8f2;">EnsureHttp</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">ensureHttp</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">startServer</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">getServer</span><span style="color: #f92672;">()).</span><span style="color: #a6e22e;">gotStubsCommitmentsDone</span><span style="color: #f92672;">();</span><br />    <span style="color: #f92672;">}</span><br /><br /><span style="color: #f92672;">}</span><br /></pre></div></div><div><br /></div><div>But this test fails because DELETE stubs are not invoked.</div><!-- HTML generated using hilite.me --><br /><div style="background: #272822; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #f8f8f2;">MyAppTest</span> <span style="color: #f92672;">&gt;</span> <span style="color: #f8f8f2;">testArchiveOldComments</span> <span style="color: #66d9ef;">FAILED</span><br />    <span style="color: #f8f8f2;">java.lang.AssertionError</span> <span style="color: #f8f8f2;">at</span> <span style="color: #f8f8f2;">MyAppTest.java:</span><span style="color: #ae81ff;">72</span><br /><br /><span style="color: #f8f8f2;">Expected</span> <span style="color: #f8f8f2;">stub</span> <span style="color: #f8f8f2;">com.xebialabs.restito.semantics.Stub@</span><span style="color: #ae81ff;">775449</span><span style="color: #f8f8f2;">c1</span> <span style="color: #f8f8f2;">to</span> <span style="color: #f8f8f2;">be</span> <span style="color: #f8f8f2;">called</span> <span style="color: #ae81ff;">1</span> <span style="color: #f8f8f2;">times,</span> <span style="color: #f8f8f2;">called</span> <span style="color: #ae81ff;">0</span> <span style="color: #f8f8f2;">times</span> <span style="color: #f8f8f2;">instead</span><br /><span style="color: #f8f8f2;">java.lang.AssertionError:</span> <span style="color: #f8f8f2;">Expected</span> <span style="color: #f8f8f2;">stub</span> <span style="color: #f8f8f2;">com.xebialabs.restito.semantics.Stub@</span><span style="color: #ae81ff;">775449</span><span style="color: #f8f8f2;">c1</span> <span style="color: #f8f8f2;">to</span> <span style="color: #f8f8f2;">be</span> <span style="color: #f8f8f2;">called</span> <span style="color: #ae81ff;">1</span> <span style="color: #f8f8f2;">times,</span> <span style="color: #f8f8f2;">called</span> <span style="color: #ae81ff;">0</span> <span style="color: #f8f8f2;">times</span> <span style="color: #f8f8f2;">instead</span><br /></pre></div><div><br /></div><div><i>Note</i>: You can see the error output is not comprehensive. It is known issue, see <a href="https://github.com/mkotsur/restito/issues/45">https://github.com/mkotsur/restito/issues/45</a>.</div><div><br /></div><div>The reason why DELETE methods are not invoked is that the first GET call does not return JSON with 3 comments but just 1 (JSON in <span style="font-family: &quot;verdana&quot; , sans-serif; font-size: x-small;">GET_COMMENTS_AFTER</span> String). It means that the second <span style="font-family: &quot;verdana&quot; , sans-serif; font-size: x-small;">GET /comments</span> stub overrides the first one. Or, the first stub that returns&nbsp;JSON with 3 comments (<span style="font-family: &quot;verdana&quot; , sans-serif; font-size: x-small;">GET_COMMENTS_BEFORE</span> String) is ignored because the <span style="font-family: &quot;verdana&quot; , sans-serif; font-size: x-small;">match</span> <a href="https://mkotsur.github.io/restito/javadoc/current/com/xebialabs/restito/semantics/Condition.html">Conditions</a> for both stubs are identical.</div><div><br /></div><div>Unfortunately Restito does not support directly this use case. Fortunately you can create <span style="font-family: &quot;verdana&quot; , sans-serif; font-size: x-small;">custom</span> <a href="https://mkotsur.github.io/restito/javadoc/current/com/xebialabs/restito/semantics/Action.html#custom-com.xebialabs.restito.semantics.Function-">Action</a> or <a href="https://mkotsur.github.io/restito/javadoc/current/com/xebialabs/restito/semantics/Condition.html#custom-com.xebialabs.restito.semantics.Predicate-">Condition</a>. Described use-case can be solved by custom Action.</div><!-- HTML generated using hilite.me --><br /><div style="background: #272822; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">java.util.LinkedList</span><span style="color: #f92672;">;</span><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">java.util.Queue</span><span style="color: #f92672;">;</span><br /><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">com.xebialabs.restito.semantics.Action</span><span style="color: #f92672;">;</span><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">com.xebialabs.restito.semantics.Function</span><span style="color: #f92672;">;</span><br /><span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.glassfish.grizzly.http.server.Response</span><span style="color: #f92672;">;</span><br /><br /><span style="color: #66d9ef;">public</span> <span style="color: #66d9ef;">class</span> <span style="color: #a6e22e;">SequencedAction</span> <span style="color: #66d9ef;">implements</span> <span style="color: #f8f8f2;">Function</span><span style="color: #f92672;">&lt;</span><span style="color: #f8f8f2;">Response</span><span style="color: #f92672;">,</span> <span style="color: #f8f8f2;">Response</span><span style="color: #f92672;">&gt;</span> <span style="color: #f92672;">{</span><br />    <span style="color: #66d9ef;">private</span> <span style="color: #f8f8f2;">Queue</span><span style="color: #f92672;">&lt;</span><span style="color: #f8f8f2;">Action</span><span style="color: #f92672;">&gt;</span> <span style="color: #f8f8f2;">queue</span> <span style="color: #f92672;">=</span> <span style="color: #66d9ef;">new</span> <span style="color: #f8f8f2;">LinkedList</span><span style="color: #f92672;">&lt;&gt;();</span><br /><br />    <span style="color: #66d9ef;">public</span> <span style="color: #a6e22e;">SequencedAction</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">Action</span><span style="color: #f92672;">...</span> <span style="color: #f8f8f2;">actions</span><span style="color: #f92672;">)</span> <span style="color: #f92672;">{</span><br />        <span style="color: #66d9ef;">for</span> <span style="color: #f92672;">(</span><span style="color: #f8f8f2;">Action</span> <span style="color: #f8f8f2;">action</span> <span style="color: #f92672;">:</span> <span style="color: #f8f8f2;">actions</span><span style="color: #f92672;">)</span> <span style="color: #f92672;">{</span><br />            <span style="color: #66d9ef;">this</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">queue</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">offer</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">action</span><span style="color: #f92672;">);</span><br />        <span style="color: #f92672;">}</span><br />    <span style="color: #f92672;">}</span><br /><br />    <span style="color: #a6e22e;">@Override</span><br />    <span style="color: #66d9ef;">public</span> <span style="color: #f8f8f2;">Response</span> <span style="color: #a6e22e;">apply</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">Response</span> <span style="color: #f8f8f2;">input</span><span style="color: #f92672;">)</span> <span style="color: #f92672;">{</span><br />        <span style="color: #f8f8f2;">Action</span> <span style="color: #f8f8f2;">next</span> <span style="color: #f92672;">=</span> <span style="color: #f8f8f2;">queue</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">poll</span><span style="color: #f92672;">();</span><br />        <span style="color: #66d9ef;">if</span> <span style="color: #f92672;">(</span><span style="color: #f8f8f2;">next</span> <span style="color: #f92672;">!=</span> <span style="color: #66d9ef;">null</span><span style="color: #f92672;">)</span> <span style="color: #f92672;">{</span><br />            <span style="color: #f8f8f2;">input</span> <span style="color: #f92672;">=</span> <span style="color: #f8f8f2;">next</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">apply</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">input</span><span style="color: #f92672;">);</span><br />        <span style="color: #f92672;">}</span><br />        <span style="color: #66d9ef;">return</span> <span style="color: #f8f8f2;">input</span><span style="color: #f92672;">;</span><br />    <span style="color: #f92672;">}</span><br /><span style="color: #f92672;">}</span><br /></pre></div><div><br /></div><div>Custom <span style="font-family: &quot;verdana&quot; , sans-serif; font-size: x-small;"><b>SequencedAction</b></span> keeps a <span style="font-family: Verdana, sans-serif; font-size: x-small;">queue</span> of not yet processed Actions and polls just one available Action from the <span style="font-family: Verdana, sans-serif; font-size: x-small;">queue</span> in <span style="font-family: Verdana, sans-serif; font-size: x-small;">apply</span> method. I.e. subsequent <span style="font-family: &quot;verdana&quot; , sans-serif; font-size: x-small;">SequencedAction.apply</span> invocation behaves differently. If the <span style="font-family: Verdana, sans-serif; font-size: x-small;">queue</span> is empty the&nbsp;<span style="font-family: &quot;verdana&quot; , sans-serif; font-size: x-small;">SequencedAction.apply</span> does nothing like <a href="https://mkotsur.github.io/restito/javadoc/current/com/xebialabs/restito/semantics/Action.html#noop--">noop</a> action.</div><div><br /></div><div>So now I can update test method to use custom action.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #272822; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #a6e22e;">@Test</span><br /><span style="color: #66d9ef;">public</span> <span style="color: #66d9ef;">void</span> <span style="color: #a6e22e;">testArchiveOldComments</span><span style="color: #f92672;">()</span> <span style="color: #f92672;">{</span><br />    <span style="color: #75715e;">// 1. Stub for both: Gets list of all open comments (GET /comments):</span><br />    <span style="color: #f8f8f2;">whenHttp</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">startServer</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">getServer</span><span style="color: #f92672;">()).</span><br />            <span style="color: #f8f8f2;">match</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">get</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"/comments"</span><span style="color: #f92672;">)).</span><br />            <span style="color: #f8f8f2;">then</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">status</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">OK_200</span><span style="color: #f92672;">),</span><br />                 <span style="color: #f8f8f2;">contentType</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"application/json"</span><span style="color: #f92672;">),</span><br />                 <span style="color: #75715e;">// use custom action:</span><br />                 <span style="color: #f8f8f2;">Action</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">custom</span><span style="color: #f92672;">(</span><span style="color: #66d9ef;">new</span> <span style="color: #f8f8f2;">SequencedAction</span><span style="color: #f92672;">(</span><br />                         <span style="color: #75715e;">// the first get: returns 3 comments</span><br />                         <span style="color: #f8f8f2;">stringContent</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">GET_COMMENTS_BEFORE</span><span style="color: #f92672;">),</span><br />                         <span style="color: #75715e;">// the second get: returns 1 comment</span><br />                         <span style="color: #f8f8f2;">stringContent</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">GET_COMMENTS_AFTER</span><span style="color: #f92672;">)</span><br />                 <span style="color: #f92672;">))).</span><br />            <span style="color: #75715e;">// 2 actions in sequence:</span><br />            <span style="color: #f8f8f2;">mustHappen</span><span style="color: #f92672;">(</span><span style="color: #ae81ff;">2</span><span style="color: #f92672;">);</span><br />    <span style="color: #75715e;">// 2. Stub for: Archives each comment that is older than a month (DELETE /comments/{id}):</span><br />    <span style="color: #f8f8f2;">whenHttp</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">startServer</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">getServer</span><span style="color: #f92672;">()).</span><br />            <span style="color: #f8f8f2;">match</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">delete</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"/comments/1"</span><span style="color: #f92672;">)).</span><br />            <span style="color: #f8f8f2;">then</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">status</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">NO_CONTENT_204</span><span style="color: #f92672;">)).</span><br />            <span style="color: #f8f8f2;">mustHappen</span><span style="color: #f92672;">();</span><br />    <span style="color: #f8f8f2;">whenHttp</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">startServer</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">getServer</span><span style="color: #f92672;">()).</span><br />            <span style="color: #f8f8f2;">match</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">delete</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"/comments/2"</span><span style="color: #f92672;">)).</span><br />            <span style="color: #f8f8f2;">then</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">status</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">NO_CONTENT_204</span><span style="color: #f92672;">)).</span><br />            <span style="color: #f8f8f2;">mustHappen</span><span style="color: #f92672;">();</span><br /><br />    <span style="color: #75715e;">// call business logic</span><br />    <span style="color: #f8f8f2;">MyApp</span> <span style="color: #f8f8f2;">myApp</span> <span style="color: #f92672;">=</span> <span style="color: #66d9ef;">new</span> <span style="color: #f8f8f2;">MyApp</span><span style="color: #f92672;">();</span><br />    <span style="color: #f8f8f2;">List</span><span style="color: #f92672;">&lt;</span><span style="color: #f8f8f2;">Comment</span><span style="color: #f92672;">&gt;</span> <span style="color: #f8f8f2;">comments</span> <span style="color: #f92672;">=</span> <span style="color: #f8f8f2;">myApp</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">archiveOldComments</span><span style="color: #f92672;">();</span><br /><br />    <span style="color: #75715e;">// remaining 1 comment:</span><br />    <span style="color: #f8f8f2;">assertThat</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">comments</span><span style="color: #f92672;">,</span> <span style="color: #f8f8f2;">hasSize</span><span style="color: #f92672;">(</span><span style="color: #ae81ff;">1</span><span style="color: #f92672;">));</span><br />    <span style="color: #75715e;">// ensure that each stubs has been invoked:</span><br />    <span style="color: #f8f8f2;">EnsureHttp</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">ensureHttp</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">startServer</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">getServer</span><span style="color: #f92672;">()).</span><span style="color: #a6e22e;">gotStubsCommitmentsDone</span><span style="color: #f92672;">();</span><br /><span style="color: #f92672;">}</span><br /></pre></div><br />And the test is fixed.<br /><br />You are right, it is a little bit too verbose to use custom action. So I have decided to contribute the sequenced action directly to Restito <span style="font-family: &quot;verdana&quot; , sans-serif; font-size: x-small;">Action</span>, method <span style="font-family: &quot;verdana&quot; , sans-serif; font-size: x-small;"><b>sequence</b></span>, see or comment or vote for my GitHub pull request:&nbsp;<a href="https://github.com/mkotsur/restito/pull/49">https://github.com/mkotsur/restito/pull/49</a>. üòá<br /><br /></div><div>Enjoy,<br />Libor</div><div><br /></div>